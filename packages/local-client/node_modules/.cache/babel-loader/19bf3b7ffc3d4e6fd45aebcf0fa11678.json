{"ast":null,"code":"import _regeneratorRuntime from\"/Users/gleb/Desktop/study/react/ts-prod/ts-codepen/packages/local-client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"/Users/gleb/Desktop/study/react/ts-prod/ts-codepen/packages/local-client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import axios from\"axios\";import localForage from\"localforage\";var fileCache=localForage.createInstance({name:\"filecache\"});export var fetchPlugin=function fetchPlugin(inputCode){return{name:\"fetch-plugin\",setup:function setup(build){build.onLoad({filter:/(^index\\.js$)/},function(){return{loader:\"jsx\",contents:inputCode};});build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(args){var cachedResult;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fileCache.getItem(args.path);case 2:cachedResult=_context.sent;if(!cachedResult){_context.next=5;break;}return _context.abrupt(\"return\",cachedResult);case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());build.onLoad({filter:/.css$/},/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(args){var _yield$axios$get,data,request,escaped,contents,result;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return axios.get(args.path);case 2:_yield$axios$get=_context2.sent;data=_yield$axios$get.data;request=_yield$axios$get.request;escaped=data.replace(/\\n/g,\"\").replace(/\"/g,'\\\\\"').replace(/'/g,\"\\\\'\");contents=\"\\n            const style = document.createElement('style');\\n            style.innerText = '\".concat(escaped,\"';\\n            document.head.appendChild(style);\\n          \");result={loader:\"jsx\",contents:contents,resolveDir:new URL(\"./\",request.responseURL).pathname};_context2.next=10;return fileCache.setItem(args.path,result);case 10:return _context2.abrupt(\"return\",result);case 11:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());build.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(args){var _yield$axios$get2,data,request,result;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return axios.get(args.path);case 2:_yield$axios$get2=_context3.sent;data=_yield$axios$get2.data;request=_yield$axios$get2.request;result={loader:\"jsx\",contents:data,resolveDir:new URL(\"./\",request.responseURL).pathname};_context3.next=8;return fileCache.setItem(args.path,result);case 8:return _context3.abrupt(\"return\",result);case 9:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref3.apply(this,arguments);};}());}};};","map":{"version":3,"names":["axios","localForage","fileCache","createInstance","name","fetchPlugin","inputCode","setup","build","onLoad","filter","loader","contents","args","getItem","path","cachedResult","get","data","request","escaped","replace","result","resolveDir","URL","responseURL","pathname","setItem"],"sources":["/Users/gleb/Desktop/study/react/ts-prod/ts-codepen/packages/local-client/src/bundler/plugins/FetchPlugin.ts"],"sourcesContent":["import axios from \"axios\";\nimport * as esbuild from \"esbuild-wasm\";\nimport localForage from \"localforage\";\n\nconst fileCache = localForage.createInstance({\n  name: \"filecache\",\n});\n\nexport const fetchPlugin = (inputCode: string) => {\n  return {\n    name: \"fetch-plugin\",\n    setup(build: esbuild.PluginBuild) {\n      build.onLoad({ filter: /(^index\\.js$)/ }, () => {\n        return {\n          loader: \"jsx\",\n          contents: inputCode,\n        };\n      });\n\n      build.onLoad({ filter: /.*/ }, async (args: any) => {\n        const cachedResult = await fileCache.getItem<esbuild.OnLoadResult>(\n          args.path\n        );\n\n        if (cachedResult) {\n          return cachedResult;\n        }\n      });\n\n      build.onLoad({ filter: /.css$/ }, async (args: any) => {\n        const { data, request } = await axios.get(args.path);\n\n        const escaped = data\n          .replace(/\\n/g, \"\")\n          .replace(/\"/g, '\\\\\"')\n          .replace(/'/g, \"\\\\'\");\n        const contents =`\n            const style = document.createElement('style');\n            style.innerText = '${escaped}';\n            document.head.appendChild(style);\n          `;\n\n        const result: esbuild.OnLoadResult = {\n          loader: \"jsx\",\n          contents,\n          resolveDir: new URL(\"./\", request.responseURL).pathname,\n        };\n        await fileCache.setItem(args.path, result);\n\n        return result;\n      });\n\n      build.onLoad({ filter: /.*/ }, async (args: any) => {\n        const { data, request } = await axios.get(args.path);\n\n        const result: esbuild.OnLoadResult = {\n          loader: \"jsx\",\n          contents: data,\n          resolveDir: new URL(\"./\", request.responseURL).pathname,\n        };\n        await fileCache.setItem(args.path, result);\n\n        return result;\n      });\n    },\n  };\n};\n"],"mappings":"4UAAA,MAAOA,MAAK,KAAM,OAAO,CAEzB,MAAOC,YAAW,KAAM,aAAa,CAErC,GAAMC,UAAS,CAAGD,WAAW,CAACE,cAAc,CAAC,CAC3CC,IAAI,CAAE,WACR,CAAC,CAAC,CAEF,MAAO,IAAMC,YAAW,CAAG,QAAdA,YAAW,CAAIC,SAAiB,CAAK,CAChD,MAAO,CACLF,IAAI,CAAE,cAAc,CACpBG,KAAK,gBAACC,KAA0B,CAAE,CAChCA,KAAK,CAACC,MAAM,CAAC,CAAEC,MAAM,CAAE,eAAgB,CAAC,CAAE,UAAM,CAC9C,MAAO,CACLC,MAAM,CAAE,KAAK,CACbC,QAAQ,CAAEN,SACZ,CAAC,CACH,CAAC,CAAC,CAEFE,KAAK,CAACC,MAAM,CAAC,CAAEC,MAAM,CAAE,IAAK,CAAC,4FAAE,iBAAOG,IAAS,2JAClBX,UAAS,CAACY,OAAO,CAC1CD,IAAI,CAACE,IAAI,CACV,QAFKC,YAAY,mBAIdA,YAAY,yDACPA,YAAY,wDAEtB,+DAAC,CAEFR,KAAK,CAACC,MAAM,CAAC,CAAEC,MAAM,CAAE,OAAQ,CAAC,6FAAE,kBAAOG,IAAS,yMAChBb,MAAK,CAACiB,GAAG,CAACJ,IAAI,CAACE,IAAI,CAAC,wCAA5CG,IAAI,kBAAJA,IAAI,CAAEC,OAAO,kBAAPA,OAAO,CAEfC,OAAO,CAAGF,IAAI,CACjBG,OAAO,CAAC,KAAK,CAAE,EAAE,CAAC,CAClBA,OAAO,CAAC,IAAI,CAAE,KAAK,CAAC,CACpBA,OAAO,CAAC,IAAI,CAAE,KAAK,CAAC,CACjBT,QAAQ,wGAEWQ,OAAO,kEAI1BE,MAA4B,CAAG,CACnCX,MAAM,CAAE,KAAK,CACbC,QAAQ,CAARA,QAAQ,CACRW,UAAU,CAAE,GAAIC,IAAG,CAAC,IAAI,CAAEL,OAAO,CAACM,WAAW,CAAC,CAACC,QACjD,CAAC,yBACKxB,UAAS,CAACyB,OAAO,CAACd,IAAI,CAACE,IAAI,CAAEO,MAAM,CAAC,0CAEnCA,MAAM,2DACd,iEAAC,CAEFd,KAAK,CAACC,MAAM,CAAC,CAAEC,MAAM,CAAE,IAAK,CAAC,6FAAE,kBAAOG,IAAS,yLACbb,MAAK,CAACiB,GAAG,CAACJ,IAAI,CAACE,IAAI,CAAC,yCAA5CG,IAAI,mBAAJA,IAAI,CAAEC,OAAO,mBAAPA,OAAO,CAEfG,MAA4B,CAAG,CACnCX,MAAM,CAAE,KAAK,CACbC,QAAQ,CAAEM,IAAI,CACdK,UAAU,CAAE,GAAIC,IAAG,CAAC,IAAI,CAAEL,OAAO,CAACM,WAAW,CAAC,CAACC,QACjD,CAAC,wBACKxB,UAAS,CAACyB,OAAO,CAACd,IAAI,CAACE,IAAI,CAAEO,MAAM,CAAC,yCAEnCA,MAAM,0DACd,iEAAC,CACJ,CACF,CAAC,CACH,CAAC"},"metadata":{},"sourceType":"module"}